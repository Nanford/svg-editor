# 产品需求设计文档——Web 在线 SVG 编辑器

## 0. 文档目的与交付边界

这份文档面向研发与测试，用来直接开工实现一个“浏览器内轻量 SVG 编辑器”，主目标是让用户完成高频闭环：打开/新建 SVG → 可视化修改（形状、样式、文本、路径）→ 保存 SVG 与导出 PNG。产品强调“快、稳、可撤销、导出可用”，不追求专业绘图软件那种超深功能。

版本分层采用“必须交付的 V1”口径写需求；如果某些能力实现成本较高，我会在对应小节标注“可降级实现”，保证团队能按优先级落地。

---

## 1. 产品定位与核心体验原则

编辑器定位为“轻量交付工作台”，核心体验原则是：所有关键操作都应该可撤销；任何情况下尽量不丢数据（自动保存与恢复优先级高于花哨功能）；可视化编辑与源码编辑要互相一致，不能出现画布看着对但导出错的情况；导出结果要尽可能标准、干净、跨环境可用。

---

## 2. 目标用户与典型任务

目标用户是产品/运营/售前/实施/前端等“要改 SVG 并交付”的人。他们最常做的事是：改标题文字、换配色、调整大小与间距、把几个元素对齐后编组、偶尔修一下路径节点，然后导出 PNG 放到 PPT/文档，或保存 SVG 交给研发使用。

---

## 3. 术语与对象模型（研发统一口径）

文档（Document）表示一个 SVG 文件及其编辑状态。画布（Canvas）是对 SVG 根元素的可视化表达，包含宽高、背景色、viewBox 等信息。元素（Element）对应 SVG DOM 节点（rect/circle/ellipse/line/path/text/image/g 等）。分组（Group）对应 `<g>`。样式（Style）是 fill、stroke、stroke-width、opacity、dasharray、linecap、linejoin 等属性集合。变换（Transform）指 translate/scale/rotate（可以用 transform 属性或矩阵存储，但必须保证序列化一致）。命令（Command）是可撤销操作单元，用来进入 Undo/Redo 栈。

---

## 4. 总体页面结构与交互布局（需要实现的 UI 骨架）

页面采用典型三栏结构：顶部菜单栏 + 左侧工具栏 + 中间画布区 + 右侧属性面板。顶部菜单栏提供文件/编辑/对象/视图/帮助入口。左侧工具栏提供选择、手型拖拽、缩放、矩形、圆、椭圆、线段、路径、文本、图片等工具入口。中间画布区支持缩放、平移、框选、多选、对齐辅助线。右侧属性面板按“对象类型”切换显示不同属性项，并始终提供样式区与变换区。

研发实现时要保证：选中对象后，右侧面板的属性值与对象真实 SVG 属性一致；在面板修改数值后，画布实时更新；撤销/重做能回滚这些修改。

---

## 5. 功能需求（V1 必须实现）

### 5.1 文件与数据流转

用户必须能够新建空白 SVG。新建时需要选择画布宽高与背景（背景色仅作为编辑器视觉背景；导出 PNG 时可选择是否带背景）。用户必须能够打开本地 SVG 文件并载入到编辑器，载入后可继续编辑并保存。

用户必须能够导入位图（png/jpg/webp），导入后在 SVG 内生成 `<image>` 元素。V1 默认采用“嵌入 data URL”策略保证单文件可移植；如果后续要支持外链，必须在 UI 上明确提示跨域与丢失风险（V1 可不做外链）。

用户必须能够“保存 SVG”（下载到本地）。保存的 SVG 必须可在浏览器直接打开显示正确。保存时需要做一次序列化清理：保留必要命名空间与结构，避免注入编辑器私有的不可移植字段（允许保留少量 `data-*` 但要克制）。

用户必须能够“导出 PNG”。导出 PNG 需要允许选择倍率（1x/2x/3x）与背景策略（透明/使用画布背景色）。导出失败时要给明确错误提示（例如跨域图片导致导出被浏览器阻止）。

用户必须具备自动保存草稿与恢复能力。V1 要求使用 IndexedDB 或 localStorage 进行本地草稿保存，至少保存最近 1 个文档状态；在异常刷新或崩溃后再次进入页面要能提示恢复。

### 5.2 画布与视图控制

画布必须支持设置宽、高，支持常用预设尺寸（社媒/设备/纸张）。画布必须支持“按内容自适应”（Fit to Content），其行为定义为：计算所有可见元素的包围盒，按可配置边距扩展后重设 viewBox，并同步 width/height（或仅调整 viewBox，二者选其一并固定策略，避免导出混乱）。V1 建议策略是：保持 width/height 不变，仅调整 viewBox + 将内容平移到边距内，这样导出尺寸稳定。

视图必须支持缩放（滚轮/快捷键）与平移（空格+拖拽或手型工具），并显示当前缩放百分比。可选支持标尺与网格，但 V1 最低要求是提供“显示/隐藏标尺”的开关，网格可后置。

### 5.3 基础编辑与选择系统

必须支持单选、多选、框选；多选时属性面板应进入“混合状态”，仅显示可批量修改的样式项（例如 fill/stroke/opacity），几何项显示为空或“—”。必须支持拖拽移动、控制点缩放、旋转（旋转把手或面板输入角度）。必须支持吸附（对齐参考线）并可在视图菜单开关；若不做复杂吸附，至少要支持“对齐到画布边缘与中心”的辅助线。

编辑操作必须支持删除、复制、粘贴、剪切。粘贴要求在当前视口中心偏移生成，避免与原对象完全重叠导致用户误以为没粘贴成功。复制粘贴要保留元素层级与样式；如果复制的是组，粘贴应生成新的组结构。

撤销/重做是硬要求。撤销必须覆盖：新增/删除元素、移动/缩放/旋转、样式修改、文本修改、编组/解组、层级调整、路径节点编辑、源码编辑提交等。实现上建议用命令模式记录增量变更，并对连续拖拽操作做合并（mouseup 时入栈一个命令），否则栈会爆。

### 5.4 图元创建（形状/文本/图片）

必须支持矩形、圆、椭圆、直线、路径、文本、图片。形状创建的交互定义为：选择工具后在画布拖拽生成；生成后立即处于选中状态，右侧面板可编辑其几何参数（x/y/宽高/半径等）。矩形需要支持圆角（rx/ry 或统一 roundness）。

文本创建定义为：点击画布生成文本框并进入编辑状态；右侧面板可改内容、字体、字号、粗体/斜体、对齐方式。V1 允许只支持单行文本，但导出的 `<text>` 必须合法。

图片导入定义为：文件选择后生成 `<image>`，默认以图片自然尺寸或合理缩放放到视口中心，并可在面板修改宽高与位置。

### 5.5 样式与外观（V1）

每个元素必须支持 fill、stroke、stroke-width、opacity。线相关元素（line/path）必须支持 stroke-linecap、stroke-linejoin、stroke-dasharray（虚线）。模糊（blur）属于加分项但不是硬要求；如果做，建议用 `<filter>` 并注意导出兼容性。

颜色选择必须支持 HEX 输入，且要有一个简单颜色选择器。V1 不要求吸管取色。

### 5.6 编组、层级顺序与对齐

必须支持编组与解组。编组实现方式建议是创建 `<g>` 并把所选元素按原顺序移动进去，保持视觉不变；解组则把 `<g>` 的子元素提升到父级并移除组。

必须支持层级顺序调整：置顶、置底、上移一层、下移一层。实现逻辑就是 DOM 顺序调整，必须可撤销。

必须支持对齐到画布：左/水平居中/右、上/垂直居中/下。对齐到对象（以第一个选中为基准或以整体包围盒为基准）V1 可二选一，但要在交互文案里写清楚，避免争议。分布（等间距）可作为 V1.1。

### 5.7 路径编辑（V1 强需求）

路径必须支持进入“节点编辑模式”。在该模式下用户可以选中节点并拖动，支持添加节点、删除节点，支持切换节点类型（直线/曲线）以及编辑贝塞尔控制柄。必须支持关闭/打开路径（close/open）。如果短期内做不出完整曲线编辑，允许 V1 先做“仅直线节点编辑 + add/delete/close”，曲线控制柄作为增强，但要保证“Convert to Path”与基本节点操作可用。

必须支持将基础形状转换为路径（Convert to Path），转换后保留视觉一致，并可进入节点编辑。

### 5.8 源码视图（可调试与兜底）

必须提供“查看/编辑 SVG 源码”的入口。源码编辑需要具备：语法高亮（可选）与错误提示（硬要求）。当用户保存源码修改时，如果 XML 不合法，不能覆盖当前画布状态，而是提示错误并允许继续修改或取消。若合法则重新解析并刷新画布，且这一操作必须进入撤销栈（允许回滚到修改前的状态）。

源码视图与画布选择要能基本联动：选中对象时能在源码里定位到对应节点（最简单做法是给元素附加稳定 id，并在源码视图滚动到该 id）。V1 不要求复杂双向高亮，但至少要做到“画布选中 → 源码可定位”。

---

## 6. 快捷键与操作规范（V1）

快捷键需要覆盖核心效率场景：新建、打开、保存、撤销、重做、删除、复制、粘贴、编组、解组、显示源码、缩放与适配视口。具体按常见约定实现即可（Windows 使用 Ctrl，Mac 使用 ⌘），但必须在帮助菜单中列出并与实现一致。

---

## 7. 数据结构与序列化要求（给研发的硬约束）

内部状态以 SVG DOM 为事实来源，UI 面板展示值必须从 DOM 解析而来，不允许“面板一套状态、DOM 另一套状态”。对 transform 的策略必须统一：要么全部规范化为 transform 列表（translate/scale/rotate），要么统一转矩阵，但无论哪种，撤销与导出必须稳定。建议采用“内部用矩阵/分解缓存，导出时再序列化为 transform 列表”的方式，减少误差累积。

导出 SVG 时必须保证命名空间完整（至少 xmlns、xlink 如使用），并保证图片 data URL 不被截断。若出现外链图片导致导出 PNG 失败，需要在导出前检查 `<image href>` 是否为跨域 URL 并给出阻断提示。

---

## 8. 错误处理与边界条件（测试用例来源）

打开 SVG 可能包含不支持的元素（例如复杂滤镜、mask、foreignObject）。V1 允许“尽力渲染”，但必须保证不会导致编辑器崩溃；不支持的能力在属性面板里隐藏或只读。

大文件性能边界需要有阈值策略：例如当路径节点数过多或嵌入图片过大时，提示用户开启“线框模式/Wireframe”或关闭实时效果。线框模式的最低实现是：只显示轮廓 stroke，不显示 fill 与滤镜，以保证拖拽不卡。

字体不可用是常见问题。V1 至少提示“导出后在其他设备可能字体回退”，V1.1 再做“文本转路径”。

---

## 9. 验收标准（按功能可直接验收）

验收以用户闭环为主：在空白页新建 1080×1080 画布，绘制矩形与圆形，设置填充与描边，添加一段文本并修改字号与颜色，导入一张 PNG 并调整透明度，对齐三个对象后编组，保存 SVG，再导出 2x PNG。整个过程任意一步都能撤销回退，刷新页面后能从草稿恢复，导出的 SVG 在 Chrome 直接打开显示一致，导出的 PNG 尺寸与倍率正确且背景策略正确。

路径验收以可操作为准：创建 path，进入节点编辑，能增加/删除节点，能拖动节点改变形状，能 close path；将矩形 convert to path 后也能做同样操作，并且撤销/重做可回滚这些节点改动。

源码验收以安全为准：打开源码视图，故意制造一个未闭合标签，保存时必须阻止并提示；修复后保存成功并更新画布；撤销可回到保存前。

---

## 10. 开发建议的模块拆分（便于排期）

实现上建议拆为四块并行：文件与序列化导出模块、画布渲染与交互模块、属性面板与对象编辑模块、撤销重做与命令系统模块。路径编辑与源码视图是两块相对独立的增强模块，但 V1 都要进来，建议尽早出最小版本以便联调。

---

如果你希望我把这份文档进一步“更像研发任务书”，我可以继续补两样你会更好用的内容：一份是“菜单与右侧属性面板的字段级规范”（每个对象类型有哪些字段、读写规则、默认值与取值范围），另一份是“命令/撤销栈的命令清单”（每个命令存什么、怎么 apply/rollback），这样研发几乎可以直接照着写代码与单测。
